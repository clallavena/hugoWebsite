<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Clément ALLAVENA "><meta name=description content="Link Github
Summary This is a project i&amp;rsquo;ve made during my first internship during my two years University Diploma in Computer Science (DUT in France) at the DOSI of the UCA.
The aim of this project was to provide a end-to-end solution of a full working version of Prometheus and it&amp;rsquo;s exporters, with the Grafana solution to monitoring the data retrieve.
So this repository brings a solution to that problem, only using bash scripting and Perl, and also bring a genericity of the version you want to install."><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=/projects/promz/><title>PromZ :: Clément Allavena</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.d7bdd8ee18bfbf4c605488a7e5b1b92cd980dfeed2bdaeab4dd5e931a7a78bc0.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#1b1c1d><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content="#1b1c1d"><meta name=theme-color content="#1b1c1d"><meta itemprop=name content="PromZ"><meta itemprop=description content="Link Github
Summary This is a project i&rsquo;ve made during my first internship during my two years University Diploma in Computer Science (DUT in France) at the DOSI of the UCA.
The aim of this project was to provide a end-to-end solution of a full working version of Prometheus and it&rsquo;s exporters, with the Grafana solution to monitoring the data retrieve.
So this repository brings a solution to that problem, only using bash scripting and Perl, and also bring a genericity of the version you want to install."><meta itemprop=datePublished content="2019-04-18T00:00:00+00:00"><meta itemprop=dateModified content="2019-04-18T00:00:00+00:00"><meta itemprop=wordCount content="806"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="PromZ"><meta name=twitter:description content="Link Github
Summary This is a project i&rsquo;ve made during my first internship during my two years University Diploma in Computer Science (DUT in France) at the DOSI of the UCA.
The aim of this project was to provide a end-to-end solution of a full working version of Prometheus and it&rsquo;s exporters, with the Grafana solution to monitoring the data retrieve.
So this repository brings a solution to that problem, only using bash scripting and Perl, and also bring a genericity of the version you want to install."><meta property="article:published_time" content="2019-04-18 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /home/</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/projects/>Projects</a></li><li><a href=/about/about-me/>About Me</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=/projects/promz/>PromZ</a></h2><div class=post-content><h2 id=link>Link</h2><p><a href=https://github.com/clallavena/standalone_prometheus>Github</a></p><h2 id=summary>Summary</h2><p>This is a project i&rsquo;ve made during my first internship during my two years University Diploma in Computer Science (DUT in France) at the <a href=https://dsi.uca.fr/organisation>DOSI</a> of the UCA.</p><p>The aim of this project was to provide a end-to-end solution of a full working version of Prometheus and it&rsquo;s exporters, with the Grafana solution to monitoring the data retrieve.</p><p>So this repository brings a solution to that problem, only using bash scripting and Perl, and also bring a genericity of the version you want to install.</p><p>During this internship, when i was providing the solution, i&rsquo;ve also made a proof of concept of this solution and made a real analysis of the performance according to the infrastructure.</p><h3 id=readme-of-the-projects>README of the projects</h3><p>Look at this <a href=https://github.com/clallavena/standalone_prometheus>link</a> to see all the README of the project</p><p>One of the readme (explaining the purposes of each scripts):</p><h3 id=this-setup-are-made-for-all-system-on-a-redhat-os-make-sure-execute-these-scripts-in-sudo-mode>This setup are made for all system on a RedHat OS. Make sure execute these scripts in sudo mode.</h3><hr><p>For each script:</p><ul><li>Return 1: if you&rsquo;re not in sudo mode</li><li>Return 2: if a files is missing</li><li>Return 3: if a directory is missing</li><li>Return 4: if empty string</li><li>Return 5: if Unknown option error</li></ul><p><a href=https://github.com/prometheus/prometheus/wiki/Default-port-allocations>Default port allocations</a></p><h2 id=installprometheus><strong>InstallPrometheus</strong></h2><p>InstallPrometheus is a bash script that install a basic configuration of Prometheus.
You can specify the version you want to install with -l and &ndash;link option, but by default it install the v2.9.2 (can be changed in the script).
A prometheus user is created and set him the owner of /etc/prometheus; /var/lib/prometheus (datastorage)</p><p>Here is the help view of the option for InstallPrometheus script.</p><pre><code>usage: InstallPrometheus.sh [-h | --help] [-l | --link] &lt;link&gt; [-n | --not-activated]	[-s | --smtp-host] &lt;new-smtp-host&gt;  [-f | --file-name] &lt;new-file-name&gt; [-r | --receiver] &lt;receiver&gt;
	-h | --help
		Show all the option available.
	-l | --link &lt;link&gt;
		Download the version that match with &lt;link&gt;. Default: download the latest version of the module.
	-n | --not-activated
		If this option is on, the script don't activate the service. Default: the service is enabled.
	-f | --file-name &lt;new-file-name&gt;
		If this option is on, &lt;new-file-name&gt; will be the new file name of your downloaded files. Default: prometheus-files
</code></pre><p>The script install by default a basic configuration file thus the user can change it as he want.</p><p>A basic static configuration are set in <strong>/etc/prometheus/prometheus.yml</strong>. This look like this:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>global</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=c># A unique name for one job.</span><span class=w>
</span><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;prometheus&#39;</span><span class=w>
</span><span class=w>    </span><span class=c># How frequently to scraped targets from this job</span><span class=w>
</span><span class=w>    </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span><span class=w>    </span><span class=c># Configure this target statically.</span><span class=w>
</span><span class=w>    </span><span class=c># For a more dynamic configuration, take a look to other methods like &lt;dns_sd_configs&gt;, &lt;file_sd_configs&gt; or &lt;openstack_sd_configs&gt; </span><span class=w>
</span><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;localhost:9090&#39;</span><span class=p>]</span><span class=w>
</span></code></pre></div><p>That means that your prometheus is set statically in localhost:9090.</p><p>For more information, look at: <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/>Configuration Documentation</a></p><p>A service is created for prometheus at <strong>/etc/systemd/system/prometheus.service</strong></p><h2 id=installingnodeexporter><strong>InstallingNodeExporter</strong></h2><p>InstallingNodeExporter is a bash script that install node_exporter which is an exporter provide by <a href=https://github.com/prometheus/>github.com/prometheus</a>, it allow to have metrics for hardware and OS.
A node_exporter user is created and it has the own of /usr/local/bin/node-exporter-files (default).</p><p>A service is created for Node Exporter at /etc/systemd/system/node_exporter.service
The AddNodeToConfig.sh script add the node exporter to the prometheus config</p><h2 id=addnotetoconfig><strong>AddNoteToConfig</strong></h2><p>That script add to the prometheus configuration a static configuration of node exporter:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;node_exporter&#39;</span><span class=w>
</span><span class=w>   </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span><span class=w>   </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span><span class=w>     </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;localhost:9100&#39;</span><span class=p>]</span><span class=w>
</span></code></pre></div><p>in /etc/prometheus/prometheus.yml</p><p>The metrics of your node Exporter are available in the 9100 ports in the localhost machine. (default)</p><h2 id=installgrafana><strong>InstallGrafana</strong></h2><p>That script install the latest stable version (6.1.4) at this day (April 2019)</p><h2 id=installalertmanager><strong>InstallAlertManager</strong></h2><p>That script install the AlertManager plugin for prometheus. It established a email alert only available in the intranet of the DSI. With the option you are able to change the smtp host and the receiver if you want. <strong>Check ./InstallAlertManager.sh -h for more information</strong>
A basic configuration of alertmanager is created at /etc/alertmanager/alertmanager.yml</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=c># Documentation: https://prometheus.io/docs/alerting/configuration/</span><span class=w>
</span><span class=w></span><span class=c># Good example: https://github.com/prometheus/alertmanager/blob/master/doc/examples/simple.yml </span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>global</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>resolve_timeout</span><span class=p>:</span><span class=w> </span><span class=l>5m</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=nt>smtp_smarthost</span><span class=p>:</span><span class=w> </span><span class=l>$smtpHost</span><span class=w>
</span><span class=w>  </span><span class=nt>smtp_from</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;alertmanager@infra.dsi.uca.fr&#39;</span><span class=w>
</span><span class=w>  </span><span class=nt>smtp_require_tls</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>route</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=c>#  group_by: [&#39;alertname&#39;, &#39;cluster&#39;, &#39;service&#39;]</span><span class=w>
</span><span class=w>  </span><span class=nt>group_wait</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span><span class=w>  </span><span class=nt>group_interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span><span class=w>  </span><span class=nt>repeat_interval</span><span class=p>:</span><span class=w> </span><span class=l>1h</span><span class=w>
</span><span class=w>  </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;email&#39;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Can define several  &#39;routes:&#39; field which is a child route tree.</span><span class=w>
</span><span class=w></span><span class=c># Theses routes can perfome a regular expression were alert can match with this regex.</span><span class=w>
</span><span class=w></span><span class=c># Allow to catch alert and permit to define a special receiver for each alert (dev, infra, ...)</span><span class=w>
</span><span class=w></span><span class=c># example: https://github.com/prometheus/alertmanager/blob/master/doc/examples/simple.yml</span><span class=w>
</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;web.hook&#39;</span><span class=w>
</span><span class=w>  </span><span class=nt>webhook_configs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://127.0.0.1:5001/&#39;</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;email&#39;</span><span class=w>
</span><span class=w>  </span><span class=nt>email_configs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;$receiver&#39;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># Mute any warning-level notifications if the same alertis already critical</span><span class=w>
</span><span class=w></span><span class=nt>inhibit_rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>source_match</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;critical&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>target_match</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;warning&#39;</span><span class=w>
</span><span class=w></span><span class=c>#    equal: [&#39;alertname&#39;, &#39;cluster&#39;, &#39;service&#39;]</span><span class=w>
</span></code></pre></div><p>Check the link for an example and the documentation for fill this file.</p><p>A basic rules files is created at /etc/prometheus/rules.yml</p><div class=highlight><pre class=chroma><code class=language-yml data-lang=yml><span class=nt>groups</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>up</span><span class=w>
</span><span class=w>    </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>InstanceDown</span><span class=w>
</span><span class=w>      </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>up == 0</span><span class=w>
</span><span class=w>      </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>page</span><span class=w>
</span><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=l>\&#34;Instance {{ \$labels.instance }} down\&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>\&#34;{{ \$labels.instance }} of job {{ \$labels.job }} has been down for more than 1 minutes.&#34;&#34;</span><span class=w>
</span></code></pre></div><p>That&rsquo;s a rule that check if the instances on prometheus are down for more than 1 minutes, if they are, firing an alert on alertmanager.</p><h2 id=uninstall>Uninstall</h2><p>The uninstall program, uninstall all of the files that have been install with the previous scripts. Disable, stop and remove all of services linked to prometheus.</p><h2 id=setup>Setup</h2><p>The setup program is a menu that allow to user to install the scripts they want without having access to the source program.</p></div></article><hr><div class=post-info></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2021</span>
<span><a href>Clément ALLAVENA</a></span>
<span><a href=posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.2ce64ea6ea44a72b13dd812fc2eb5cca3efe878cce258a47c137c17edf46e0602a05e422b618a5b80b5939c731b7a293351c2f2222a21f6ee27e54a8448dd20e.js integrity="sha512-LOZOpupEpysT3YEvwutcyj7+h4zOJYpHwTfBft9G4GAqBeQithiluAtZOccxt6KTNRwvIiKiH27iflSoRI3SDg=="></script></body></html>